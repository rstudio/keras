<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Writing Custom Keras Layers • keras</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Writing Custom Keras Layers">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">keras</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">2.1.6.9005</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Getting Started</li>
    <li>
      <a href="../articles/why_use_keras.html">Why Use Keras?</a>
    </li>
    <li>
      <a href="../articles/sequential_model.html">Guide to the Sequential Model</a>
    </li>
    <li>
      <a href="../articles/functional_api.html">Guide to the Functional API</a>
    </li>
    <li>
      <a href="../articles/faq.html">Frequently Asked Questions</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Using Keras</li>
    <li>
      <a href="../articles/about_keras_models.html">About Keras Models</a>
    </li>
    <li>
      <a href="../articles/about_keras_layers.html">About Keras Layers</a>
    </li>
    <li>
      <a href="../articles/training_visualization.html">Training Visualization</a>
    </li>
    <li>
      <a href="../articles/applications.html">Pre-Trained Models</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/training_callbacks.html">Training Callbacks</a>
    </li>
    <li>
      <a href="../articles/backend.html">Keras Backend</a>
    </li>
    <li>
      <a href="../articles/custom_layers.html">Custom Layers</a>
    </li>
    <li>
      <a href="../articles/custom_models.html">Custom Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/learn.html">Learn</a>
</li>
<li>
  <a href="../articles/tools.html">Tools</a>
</li>
<li>
  <a href="../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://github.com/rstudio/keras">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Writing Custom Keras Layers</h1>
            
      
      
      <div class="hidden name"><code>custom_layers.Rmd</code></div>

    </div>

    
    
<p>If the existing Keras layers don’t meet your requirements you can create a custom layer. For simple, stateless custom operations, you are probably better off using <code><a href="../reference/layer_lambda.html">layer_lambda()</a></code> layers. But for any custom operation that has trainable weights, you should implement your own layer.</p>
<p>The example below illustrates the skeleton of a Keras custom layer. The <a href="https://keras.rstudio.com/articles/examples/mnist_antirectifier.html">mnist_antirectifier</a> example includes another demonstration of creating a custom layer.</p>
<div id="keraslayer-r6-class" class="section level2">
<h2 class="hasAnchor">
<a href="#keraslayer-r6-class" class="anchor"></a>KerasLayer R6 Class</h2>
<p>To create a custom Keras layer, you create an R6 class derived from <code>KerasLayer</code>. There are three methods to implement (only one of which, <code>call()</code>, is required for all types of layer):</p>
<ul>
<li>
<code>build(input_shape)</code>: This is where you will define your weights. Note that if your layer doesn’t define trainable weights then you need not implemented this method.</li>
<li>
<code>call(x)</code>: This is where the layer’s logic lives. Unless you want your layer to support masking, you only have to care about the first argument passed to <code>call</code>: the input tensor.</li>
<li>
<code>compute_output_shape(input_shape)</code>: In case your layer modifies the shape of its input, you should specify here the shape transformation logic. This allows Keras to do automatic shape inference. If you don’t modify the shape of the input then you need not implement this method.</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(keras)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">CustomLayer &lt;-<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(<span class="st">"CustomLayer"</span>,</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">                                  </a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="dt">inherit =</span> KerasLayer,</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  <span class="dt">public =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    </a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="dt">output_dim =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    </a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    <span class="dt">kernel =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    </a>
<a class="sourceLine" id="cb1-13" data-line-number="13">    <span class="dt">initialize =</span> <span class="cf">function</span>(output_dim) {</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">      self<span class="op">$</span>output_dim &lt;-<span class="st"> </span>output_dim</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">    },</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">    </a>
<a class="sourceLine" id="cb1-17" data-line-number="17">    <span class="dt">build =</span> <span class="cf">function</span>(input_shape) {</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">      self<span class="op">$</span>kernel &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">add_weight</span>(</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">        <span class="dt">name =</span> <span class="st">'kernel'</span>, </a>
<a class="sourceLine" id="cb1-20" data-line-number="20">        <span class="dt">shape =</span> <span class="kw">list</span>(input_shape[[<span class="dv">2</span>]], self<span class="op">$</span>output_dim),</a>
<a class="sourceLine" id="cb1-21" data-line-number="21">        <span class="dt">initializer =</span> <span class="kw"><a href="../reference/initializer_random_normal.html">initializer_random_normal</a></span>(),</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">        <span class="dt">trainable =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">      )</a>
<a class="sourceLine" id="cb1-24" data-line-number="24">    },</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">    </a>
<a class="sourceLine" id="cb1-26" data-line-number="26">    <span class="dt">call =</span> <span class="cf">function</span>(x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">      <span class="kw"><a href="../reference/k_dot.html">k_dot</a></span>(x, self<span class="op">$</span>kernel)</a>
<a class="sourceLine" id="cb1-28" data-line-number="28">    },</a>
<a class="sourceLine" id="cb1-29" data-line-number="29">    </a>
<a class="sourceLine" id="cb1-30" data-line-number="30">    <span class="dt">compute_output_shape =</span> <span class="cf">function</span>(input_shape) {</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">      <span class="kw">list</span>(input_shape[[<span class="dv">1</span>]], self<span class="op">$</span>output_dim)</a>
<a class="sourceLine" id="cb1-32" data-line-number="32">    }</a>
<a class="sourceLine" id="cb1-33" data-line-number="33">  )</a>
<a class="sourceLine" id="cb1-34" data-line-number="34">)</a></code></pre></div>
<p>Note that tensor operations are executed using the Keras <code><a href="../reference/backend.html">backend()</a></code>. See the <a href="backend.html">Keras Backend</a> article for details on the various functions available from Keras backends.</p>
</div>
<div id="layer-wrapper-function" class="section level2">
<h2 class="hasAnchor">
<a href="#layer-wrapper-function" class="anchor"></a>Layer Wrapper Function</h2>
<p>In order to use the custom layer within a Keras model you also need to create a wrapper function which instantiates the layer using the <code><a href="../reference/create_layer.html">create_layer()</a></code> function. For example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># define layer wrapper function</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">layer_custom &lt;-<span class="st"> </span><span class="cf">function</span>(object, output_dim, <span class="dt">name =</span> <span class="ot">NULL</span>, <span class="dt">trainable =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="kw"><a href="../reference/create_layer.html">create_layer</a></span>(CustomLayer, object, <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="dt">output_dim =</span> <span class="kw">as.integer</span>(output_dim),</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    <span class="dt">name =</span> name,</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="dt">trainable =</span> trainable</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  ))</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co"># use it in a model</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/keras_model_sequential.html">keras_model_sequential</a></span>()</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="st">  </span><span class="kw"><a href="../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">32</span>, <span class="dt">input_shape =</span> <span class="kw">c</span>(<span class="dv">32</span>,<span class="dv">32</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="st">  </span><span class="kw">layer_custom</span>(<span class="dt">output_dim =</span> <span class="dv">32</span>)</a></code></pre></div>
<p>Some important things to note about the layer wrapper function:</p>
<ol style="list-style-type: decimal">
<li><p>It accepts <code>object</code> as its first parameter (the object will either be a Keras sequential model or another Keras layer). The <code>object</code> parameter enables the layer to be composed with other layers using the magrittr pipe (<code>%&gt;%</code>) operator.</p></li>
<li><p>It converts it’s <code>output_dim</code> to integer using the <code>as.integer()</code> function. This is done as convenience to the user because Keras variables are strongly typed (you can’t pass a float if an integer is expected). This enables users of the function to write <code>output_dim = 32</code> rather than <code>output_dim = 32L</code>.</p></li>
<li><p>Some additional parameters not used by the layer (<code>name</code> and <code>trainable</code>) are in the function signature. Custom layer functions can include any of the core layer function arguments (<code>input_shape</code>, <code>batch_input_shape</code>, <code>batch_size</code>, <code>dtype</code>, <code>name</code>, <code>trainable</code>, and <code>weights</code>) and they will be automatically forwarded to the Layer base class.</p></li>
</ol>
<p>See the <a href="https://keras.rstudio.com/articles/examples/mnist_antirectifier.html">mnist_antirectifier</a> example for another demonstration of creating a custom layer.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#keraslayer-r6-class">KerasLayer R6 Class</a></li>
      <li><a href="#layer-wrapper-function">Layer Wrapper Function</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by JJ Allaire, François Chollet,  RStudio,  Google.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
